---
title: "Screen Time Data Viz"
author: Taren Sanders
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE
)
```

```{r load-data}
library(tidyverse)
library(patchwork)
df <- read_csv("https://raw.githubusercontent.com/Motivation-and-Behaviour/screen_umbrella/main/supplementary_files/Complete%20Effects%20Data.csv") # nolint
```

```{r tidy-data}
df <- df %>%
  mutate(
    plain_language_exposure =
      str_replace(plain_language_exposure, "Video game console", "Video games"),
    general_outcome = str_extract(plain_language_outcome, "[^:]+"),
    general_exposure = str_extract(plain_language_exposure, "[^:]+"),
    specific_outcome = gsub(".*: ", "", plain_language_outcome),
    specific_exposure = gsub(".*: ", "", plain_language_exposure),
    general_exposure =
      str_replace(general_exposure, "Screen use", "General screen use"),
    age_group_code = case_when(
      age_group == "All" ~ 0,
      age_group == "Young children" ~ 1,
      age_group == "Children" ~ 2,
      age_group == "Adolescents" ~ 3
    ),
    r = if_else(is.na(reanalysis_r), converted_r, reanalysis_r),
    r_lb = if_else(
      is.na(reanalysis_cilb_95), converted_cilb, reanalysis_cilb_95
    ),
    r_ub = if_else(
      is.na(reanalysis_ciub_95), converted_cilb, reanalysis_ciub_95
    ),
    n = if_else(
      is.na(reanalysis_n), original_n, reanalysis_n
    ),
    k = if_else(
      is.na(reanalysis_k), original_k, reanalysis_k
    )
  )
```

# Scenario One

> A parent wants to explore the types of exposure.
> The select a particular exposure (e.g., TV) might impact their child.
> They search for the exposure and are given an overview of the known outcome categories.
> Visualise info about the uncertainty for each effect.
> They filter the results for their child's age.
> They click into an outcome category to get more information on the result (e.g., text summary, info about reason for the uncertainty).


## Task One

> Explore the exposures that there are evidence for.

### Effect Counts

#### General Categories

```{r hm-counts, layout="l-page"}
df %>%
  group_by(general_exposure, general_outcome) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = general_exposure, y = general_outcome, fill = n)) +
  geom_tile() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

#### Subcategories

Don't think this works.

```{r hm-subcounts, layout="l-page"}
df %>%
  group_by(plain_language_exposure, plain_language_outcome) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = plain_language_exposure, y = plain_language_outcome, fill = n)) +
  geom_tile() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Effect Sizes

#### General Categories

I think this is my preferred option, although it does have some issues.

```{r hm-es, layout="l-page"}
df %>%
  group_by(general_exposure, general_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = general_exposure, y = general_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal()
```

**Problems**

* The only way to reduce the data (that I could think of) is to take the mean, but that gives a pretty inaccurate view of some of the categories.


#### Subcategories

Don't think this works.

```{r hm-subes, layout="l-page"}
df %>%
  group_by(plain_language_exposure, plain_language_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = plain_language_exposure, y = plain_language_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
#### Mixed General and Subcategories

This also works, especially if I could combine the subcategories to show the 'range' of effect sizes. Could not come up with a way to do that though.

```{r hm-mixes, layout="l-page"}
df %>%
  group_by(general_exposure, plain_language_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = general_exposure, y = plain_language_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Task Two

> Explore an overview of the outcome categories for the selected exposure category.

(*E.g., if they have chosen 'video games'*)

### Idea One

Using length as the main idiom.

```{r, layout="l-page"}
df %>%
  filter(general_exposure == "Video games") %>%
  ggplot(aes(
    x = plain_language_outcome,
    y = r,
    ymin = r_lb,
    ymax = r_ub,
    fill = age_group,
    col = age_group
  )) +
  geom_linerange(position = position_dodge(width = 0.5), size = 3) +
  geom_point(
    size = 2, shape = 21,
    color = "white", stroke = 0.5, position = position_dodge(width = 0.5)
  ) +
  scale_y_continuous(name = "Correlation", limits = c(-0.8, 0.8)) +
  coord_flip() +
  theme_minimal(base_size = 5)
```

#### Notes

* Points are showing effects, line ranges are showing confidence intervals (so showing some aspects of uncertainty).
* There's still lots of information that this doesn't show (such as sample size or number of studies which are part of uncertainty)
* There's multiple points for some because there are sub-categories for 'video games' (e.g., violent video games, or educational), but it makes the plot a bit messy.
* There's some issues with a few of the data points that I'll resolve in the original dataset

### Idea Two

Using position as the main idiom.

```{r, layout="l-page", fig.height=6, fig.width=8}
p <- df %>%
  filter(general_exposure == "Video games") %>%
  ggplot(aes(
    y = log(n), x = r,
    color = general_outcome,
    text = plain_language_outcome
  )) +
  geom_point(size = 5) +
  theme_minimal()

plotly::ggplotly(p, tooltip = "text")
```
#### Notes

* Effect size indicated by horizontal position, but now missing uncertainty from the confidence intervals.
* Incorporates a different form of uncertainty (i.e., sample size) on the y-axis
* I guess it could incorporate other data through shape, but it looks a bit messy to message

<aside>
```{r}
df %>%
  filter(general_exposure == "Video games") %>%
  ggplot(aes(x = log(n), y = r, color = general_outcome, shape = age_group)) +
  geom_point(size = 10) +
  theme_minimal()
```
</aside>

## Task Three

> Visualise the uncertainty for the selected exposure.

(*Not sure how to do this one*)

## Task Four

> Filter the results by child's age

### Idea one

This is just the same as Task Two. E.g.,:

```{r, layout="l-page", fig.height=6, fig.width=8}
p <- df %>%
  filter(general_exposure == "Video games", age_group == "Children") %>%
  ggplot(aes(
    y = log(n), x = r,
    color = general_outcome,
    text = plain_language_outcome
  )) +
  geom_point(size = 5) +
  theme_minimal()

plotly::ggplotly(p, tooltip = "text")
```

## Task Five

> Click into an otcome category to get additional information on the result.

(*Can't really do this is ggplot*)


# Scenario Two

> A domain expert wants to explore evidence for screen time in more detail.
> Use the system to get an overview of the evidence (exposure, outcome, effect size).
> They search for the exposure and/or the outcome, and optionally filter by age.
> They click into a relationship and can access the forest plot of the original studies, and the link to the original meta-analysis (and other, related studies, uncertainty). Three levels: evidence, uncertainty, meta-data.

## Task One

> Explore the outcomes that there are evidence for.

Same as in [Scenario One].

## Task Two

> Explore the evidence for the selected exposure.

This is the same as [Scenario One]. To look at a difference, let's imagine that they are instead searching by outcome.

(*E.g., they choose 'body composition'*)

### Idea One

```{r layout="l-page", fig.height=6}
df %>%
  filter(general_outcome == "Body composition") %>%
  group_by(general_exposure, specific_exposure, age_group) %>%
  summarise(r_min = min(r_lb), r_max = max(r_ub)) %>%
  ungroup() %>%
  ggplot(aes(
    x = specific_exposure,
    ymin = r_min,
    ymax = r_max,
    fill = age_group,
    col = age_group
  )) +
  geom_linerange(position = position_dodge(width = 1), size = 3) +
  geom_hline(yintercept = 0) +
  # scale_y_continuous(name = "Correlation", limits = c(-0.8, 0.8)) +
  facet_wrap(
    ~general_exposure,
    ncol = 1, scale = "free_y"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(strip.text.x = element_text(hjust = 0.00, face = "bold"))
```

## Task Three

> Visualise the uncertainty for the selected exposure.

Same as [Scenario One]. 

## Task Four

> Filter the results by child's age

Same as [Scenario One]. 

## Task Five

> Explore the underlying data and meta-data

I've realised that I'll need to relink the original study-level data back to this to show original forest plots.

Otherwise, one option would be to display a relationship and show the forest plots in the tooltip?

```{r, layout="l-page", fig.height=6, fig.width=8}
p <- df %>%
  filter(general_outcome == "Body composition") %>%
  ggplot(aes(
    y = log(n), x = r,
    color = general_exposure,
    text = plain_language_exposure
  )) +
  geom_point(size = 5) +
  theme_minimal()

plotly::ggplotly(p, tooltip = "text")
```