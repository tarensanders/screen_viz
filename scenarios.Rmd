---
title: "Screen Time Data Viz"
author: Taren Sanders
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE
)
```

```{r load-data}
library(tidyverse)
library(patchwork)
df <- read_csv("https://raw.githubusercontent.com/Motivation-and-Behaviour/screen_umbrella/main/supplementary_files/Complete%20Effects%20Data.csv") # nolint
```

```{r tidy-data}
df <- df %>%
  mutate(
    plain_language_exposure =
      str_replace(plain_language_exposure, "Video game console", "Video games"),
    general_outcome = str_extract(plain_language_outcome, "[^:]+"),
    general_exposure = str_extract(plain_language_exposure, "[^:]+"),
    specific_outcome = gsub(".*: ", "", plain_language_outcome),
    specific_exposure = gsub(".*: ", "", plain_language_exposure),
    general_exposure =
      str_replace(general_exposure, "Screen use", "General screen use"),
    age_group = fct_relevel(
      age_group,
      c("All", "Young children", "Children", "Adolescents")
    ),
    r = if_else(is.na(reanalysis_r), converted_r, reanalysis_r),
    r_lb = if_else(
      is.na(reanalysis_cilb_95), converted_cilb, reanalysis_cilb_95
    ),
    r_ub = if_else(
      is.na(reanalysis_ciub_95), converted_ciub, reanalysis_ciub_95
    ),
    n = if_else(
      is.na(reanalysis_n), original_n, reanalysis_n
    ),
    k = if_else(
      is.na(reanalysis_k), original_k, reanalysis_k
    )
  ) %>%
  group_by(
    plain_language_outcome,
    plain_language_exposure,
    age_group
  ) %>%
  slice_max(n, with_ties = TRUE) %>%
  ungroup()
```

# Scenario One

> A parent wants to explore the types of exposure.
> The select a particular exposure (e.g., TV) might impact their child.
> They search for the exposure and are given an overview of the known outcome categories.
> Visualise info about the uncertainty for each effect.
> They filter the results for their child's age.
> They click into an outcome category to get more information on the result (e.g., text summary, info about reason for the uncertainty).


## Task One

> Explore the exposures that there are evidence for.

### Effect Counts

#### General Categories

```{r hm-counts}
df %>%
  group_by(general_exposure, general_outcome) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = general_exposure, y = general_outcome, fill = n)) +
  geom_tile() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

#### Subcategories

Don't think this works.

```{r hm-subcounts}
df %>%
  group_by(plain_language_exposure, plain_language_outcome) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = plain_language_exposure, y = plain_language_outcome, fill = n)) +
  geom_tile() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Effect Sizes

#### General Categories

I think this is my preferred option, although it does have some issues.

```{r hm-es}
df %>%
  group_by(general_exposure, general_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = general_exposure, y = general_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal()
```

**Problems**

* The only way to reduce the data (that I could think of) is to take the mean, but that gives a pretty inaccurate view of some of the categories.


#### Subcategories

Don't think this works.

```{r hm-subes}
df %>%
  group_by(plain_language_exposure, plain_language_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(
    x = plain_language_exposure,
    y = plain_language_outcome,
    fill = r
  )) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
#### Mixed General and Subcategories

This also works, especially if I could combine the subcategories to show the 'range' of effect sizes. Could not come up with a way to do that though.

```{r hm-mixes}
df %>%
  group_by(general_exposure, plain_language_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = general_exposure, y = plain_language_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Task Two

> Explore an overview of the outcome categories for the selected exposure category.

(*E.g., if they have chosen 'video games'*)

### Using a linerange

```{r}
p_df <- df %>%
  filter(general_exposure == "Video games") %>%
  select(
    general_exposure, general_outcome, plain_language_exposure,
    plain_language_outcome, r, r_ub, r_lb, age_group, n
  ) %>%
  mutate(plain_language_outcome = fct_reorder(plain_language_outcome, r)) %>%
  arrange(plain_language_outcome, r) %>%
  group_by(general_exposure, plain_language_outcome) %>%
  mutate(
    effect_id = row_number(),
    group_id = cur_group_id(),
    median_effect = median(r)
  ) %>%
  ungroup() %>%
  arrange(desc(median_effect), plain_language_outcome, desc(r)) %>%
  mutate(
    aux = row_number()
  ) %>%
  group_by(plain_language_outcome) %>%
  mutate(breaks = median(aux)) %>%
  ungroup() %>%
  mutate(
    stripe = factor(if_else(group_id %% 2 == 0, 1, 0))
  )

ggplot(p_df, aes(
  x = aux,
  y = r
)) +
  geom_linerange(aes(
    ymin = r_lb,
    ymax = r_ub,
    col = age_group
  ), size = 3) +
  geom_point(aes(
    size = log(n)
  ),
  shape = 21,
  color = "white", stroke = 0.5, fill = "black"
  ) +
  geom_rect(
    aes(
      xmax = aux + 0.5, xmin = aux - 0.5,
      ymin = -1, ymax = 1, fill = stripe
    ),
    alpha = 0.4
  ) +
  scale_y_continuous(name = "Correlation", limits = c(-1, 1)) +
  scale_x_continuous("Outcome",
    labels = unique(p_df$plain_language_outcome),
    breaks = unique(p_df$breaks)
  ) +
  scale_fill_manual(values = c("white", "grey50"), guide = "none") +
  scale_size(guide = "none") +
  coord_flip() +
  theme_minimal()
```

**Notes**

* Still need a PCA or similar for study quality. This is just using sample size.

### Using another heatmap

```{r}
df %>%
  filter(general_exposure == "Video games") %>%
  group_by(plain_language_exposure, plain_language_outcome) %>%
  summarise(r = mean(r)) %>%
  ggplot(aes(x = plain_language_exposure, y = plain_language_outcome, fill = r)) +
  geom_tile() +
  scale_fill_distiller(palette = "RdBu", limits = c(-.5, .5)) +
  theme_minimal()
```

I think I prefer the linerange.

## Task Three

> Visualise the uncertainty for the selected exposure.

(*Not sure how to do this one*)

## Task Four

> Filter the results by child's age

### Idea one

This is just the same as Task Two. E.g.,:

```{r, fig.height=6, fig.width=8}
p <- df %>%
  filter(general_exposure == "Video games", age_group == "Children") %>%
  ggplot(aes(
    y = log(n), x = r,
    color = general_outcome,
    text = plain_language_outcome
  )) +
  geom_point(size = 5) +
  theme_minimal()

plotly::ggplotly(p, tooltip = "text")
```

## Task Five

> Click into an otcome category to get additional information on the result.

(*Can't really do this is ggplot*)


# Scenario Two

> A domain expert wants to explore evidence for screen time in more detail.
> Use the system to get an overview of the evidence (exposure, outcome, effect size).
> They search for the exposure and/or the outcome, and optionally filter by age.
> They click into a relationship and can access the forest plot of the original studies, and the link to the original meta-analysis (and other, related studies, uncertainty). Three levels: evidence, uncertainty, meta-data.

## Task One

> Explore the outcomes that there are evidence for.

Same as in [Scenario One].

## Task Two

> Explore the evidence for the selected exposure.

This is the same as [Scenario One]. To look at a difference, let's imagine that they are instead searching by outcome.

(*E.g., they choose 'body composition'*)

### Idea One

```{r layout="l-page", fig.height=6}
df %>%
  filter(general_outcome == "Body composition") %>%
  group_by(general_exposure, specific_exposure, age_group) %>%
  summarise(r_min = min(r_lb), r_max = max(r_ub)) %>%
  ungroup() %>%
  ggplot(aes(
    x = specific_exposure,
    ymin = r_min,
    ymax = r_max,
    fill = age_group,
    col = age_group
  )) +
  geom_linerange(position = position_dodge(width = 1), size = 3) +
  geom_hline(yintercept = 0) +
  # scale_y_continuous(name = "Correlation", limits = c(-0.8, 0.8)) +
  facet_wrap(
    ~general_exposure,
    ncol = 1, scale = "free_y"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(strip.text.x = element_text(hjust = 0.00, face = "bold"))
```

```{r}
p_df <- df %>%
  filter(general_outcome == "Body composition") %>%
  select(
    general_exposure, general_outcome, plain_language_exposure,
    plain_language_outcome, r, r_ub, r_lb, age_group, n
  ) %>%
  mutate(plain_language_exposure = fct_reorder(plain_language_exposure, r)) %>%
  arrange(plain_language_exposure, r) %>%
  group_by(general_outcome, plain_language_exposure) %>%
  mutate(
    effect_id = row_number(),
    group_id = cur_group_id(),
    median_effect = median(r)
  ) %>%
  ungroup() %>%
  arrange(desc(median_effect), plain_language_exposure, desc(r)) %>%
  mutate(
    aux = row_number()
  ) %>%
  group_by(plain_language_exposure) %>%
  mutate(breaks = median(aux)) %>%
  ungroup() %>%
  mutate(
    stripe = factor(if_else(group_id %% 2 == 0, 1, 0))
  )

ggplot(p_df, aes(
  x = aux,
  y = r
)) +
  geom_linerange(aes(
    ymin = r_lb,
    ymax = r_ub,
    col = age_group
  ), size = 3) +
  geom_point(aes(
    size = log(n)
  ),
  shape = 21,
  color = "white", stroke = 0.5, fill = "black"
  ) +
  geom_rect(
    aes(
      xmax = aux + 0.5, xmin = aux - 0.5,
      ymin = -1, ymax = 1, fill = stripe
    ),
    alpha = 0.4
  ) +
  scale_y_continuous(name = "Correlation", limits = c(-1, 1)) +
  scale_x_continuous("Outcome",
    labels = unique(p_df$plain_language_exposure),
    breaks = unique(p_df$breaks)
  ) +
  scale_fill_manual(values = c("white", "grey50"), guide = "none") +
  scale_size(guide = "none") +
  coord_flip() +
  theme_minimal()
```

## Task Three

> Visualise the uncertainty for the selected exposure.

Same as [Scenario One]. 

## Task Four

> Filter the results by child's age

Same as [Scenario One]. 

## Task Five

> Explore the underlying data and meta-data

I've realised that I'll need to relink the original study-level data back to this to show original forest plots.

Otherwise, one option would be to display a relationship and show the forest plots in the tooltip?

```{r, fig.height=6, fig.width=8}
p <- df %>%
  filter(general_outcome == "Body composition") %>%
  ggplot(aes(
    y = log(n), x = r,
    color = general_exposure,
    text = plain_language_exposure
  )) +
  geom_point(size = 5) +
  theme_minimal()

plotly::ggplotly(p, tooltip = "text")
```